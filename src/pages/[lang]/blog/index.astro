---
import { getCollection } from 'astro:content';
import { languages } from '../../../i18n/locales'; // 注意路径层级
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import SEOHead from '../../../components/SEOHead.astro';

// 1. 生成静态路径 (为每种语言生成一个列表页)
export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;

// 2. 获取当前语言的博客文章
// 逻辑：获取所有文章 -> 过滤出 ID 以 "en/" 或 "zh/" 开头的文章
const allPosts = await getCollection('blog');
const posts = allPosts.filter((post) => post.id.startsWith(`${lang}/`));

// 按日期倒序排列
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// 获取翻译文案
let t;
try { t = (await import(`../../../i18n/${lang}.json`)).default; } 
catch (e) { t = (await import(`../../../i18n/en.json`)).default; }

// 格式化日期的辅助函数
function formatDate(date) {
  return new Date(date).toLocaleDateString(lang, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<html lang={lang}>
  <head>
    <SEOHead 
      title={`${t.nav.blog} - Nano Banana`} 
      description="Latest news and updates from Nano Banana." 
      lang={lang} 
    />
  </head>
  <body class="bg-white text-gray-900 font-sans antialiased flex flex-col min-h-screen">
    <Header lang={lang} t={t} />

    <main class="flex-grow py-20 bg-gray-50">
      <div class="max-w-5xl mx-auto px-6">
        <h1 class="text-4xl md:text-5xl font-black mb-12 text-center">{t.nav.blog}</h1>

        <div class="grid gap-10 md:grid-cols-2">
          {posts.map((post) => {
            // 处理 Slug：移除语言前缀，用于生成链接
            // 例如 post.slug 是 "en/hello-world"，我们要提取 "hello-world"
            // 链接变成 /en/blog/hello-world
            const cleanSlug = post.slug.split('/').slice(1).join('/');
            
            return (
              <article class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 group">
                <a href={`/${lang}/blog/${cleanSlug}/`}>
                  {post.data.image && (
                    <div class="aspect-video overflow-hidden">
                      <img 
                        src={post.data.image} 
                        alt={post.data.title} 
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                      />
                    </div>
                  )}
                  <div class="p-8">
                    <div class="text-sm text-yellow-600 font-bold mb-3">
                      {formatDate(post.data.pubDate)}
                    </div>
                    <h2 class="text-2xl font-bold mb-3 group-hover:text-yellow-600 transition-colors">
                      {post.data.title}
                    </h2>
                    <p class="text-gray-600 line-clamp-3 leading-relaxed">
                      {post.data.description}
                    </p>
                    <div class="mt-6 flex items-center text-sm font-bold text-black group-hover:underline">
                      Read Article →
                    </div>
                  </div>
                </a>
              </article>
            );
          })}
        </div>
        
        {posts.length === 0 && (
          <div class="text-center text-gray-500 py-20">
            <p class="text-xl">No posts found for this language yet.</p>
          </div>
        )}
      </div>
    </main>

    <Footer t={t} />
  </body>
</html>